var app=angular.module("webapps",["ui.router","ui.select","ngSanitize","fullPage.js"]);
app.config(["$stateProvider","$urlRouterProvider","$locationProvider",function(a,e,c){a.state("home",{url:"/home",views:{main:{templateUrl:"/templates/home.ejs",controller:"MainCtrl",resolve:{postPromise:["posts",function(a){return a.getAll()}]}}}});a.state("posts",{url:"/posts/{id}",views:{main:{templateUrl:"templates/posts.ejs",controller:"PostsCtrl",resolve:{post:["$stateParams","posts",function(a,d){return d.get(a.id)}]}}}});a.state("login",{url:"/login",views:{main:{templateUrl:"templates/login.ejs",
controller:"AuthCtrl",onEnter:["$state","auth",function(a,d){d.isLoggedIn()&&a.go("home")}]}}});a.state("register",{url:"/register",views:{main:{templateUrl:"templates/register.ejs",controller:"AuthCtrl",onEnter:["$state","auth",function(a,d){d.isLoggedIn()&&a.go("home")}]}}});a.state("profile",{url:"/users/{uid}",views:{main:{templateUrl:"templates/profile.ejs",controller:"ProfCtrl",onEnter:["$state","auth",function(a,d){d.isLoggedIn()||a.go("home")}]}}});a.state("chronodata",{url:"/chronology",
views:{main:{templateUrl:"pages/chronology.ejs",controller:"ChronoCtrl",resolve:{chronodataPromise:["chronodatas",function(a){return a.getAll()}]}}}});a.state("testgraph",{url:"/testgraph",views:{main:{templateUrl:"pages/graph.ejs",controller:"GraphBarCtrl"}}});e.otherwise("home")}]);app.factory("auth",["$http","$window",function(a,e){var c={saveToken:function(a){e.localStorage["webapp-token"]=a},getToken:function(){return e.localStorage["webapp-token"]},isLoggedIn:function(){var a=c.getToken();return a?JSON.parse(e.atob(a.split(".")[1])).exp>Date.now()/1E3:!1},currentUser:function(){if(c.isLoggedIn()){var a=c.getToken();return JSON.parse(e.atob(a.split(".")[1])).username}},register:function(g){return a.post("/register",g).success(function(a){c.saveToken(a.token)})},logIn:function(g){return a.post("/login",
g).success(function(a){c.saveToken(a.token)})},logOut:function(){e.localStorage.removeItem("webapp-token")}};return c}]);app.controller("AuthCtrl",["$scope","$state","auth",function(a,e,c){a.user={};a.register=function(){c.register(a.user).error(function(g){a.error=g}).then(function(){e.go("home")})};a.logIn=function(){c.logIn(a.user).error(function(g){a.error=g}).then(function(){e.go("home")})}}]);app.controller("GraphBarCtrl",["$scope","$http","$q",function(a,e,c){a.user={};a.availableUsers=[];a.funcAsync=function(g){e.get("/allusers").then(function(d){a.availableUsers=d.data;console.log(d)},function(){console.log("Error")})};a.reloadGraph=function(){for(var g=["/userdata/logon/"+a.user.selected,"/userdata/device/"+a.user.selected,"/userdata/file/"+a.user.selected],d=[],h=0;h<g.length;h++)d.push(e.get(g[h]));var k=[];c.all(d).then(function(a){a=k=k.concat(a[0].data,a[1].data,a[2].data);var d=
[],g=[],c=[],e=[],h=[],p=[],q=[],r=[],s=[],t=[],u=[],v=[],w=[],x=[],y=[],z=[],A=[],B=[],C=[],D=[],E=[],F=[];fdelete_y=[];fdelete_text=[];for(var b=0;b<a.length;b++){var f;f=new Date(a[b].date);f=f.getFullYear()+"-"+("0"+(f.getMonth()+1)).slice(-2)+"-"+("0"+f.getDate()).slice(-2);switch(a[b].activity){case "Logon":d.push(f);g.push("Logon/Logoff");c.push("User "+a[b].user_id+" <br>on "+a[b].pc+" <br>@ "+f);break;case "Logoff":e.push(f);h.push("Logon/Logoff");p.push("User "+a[b].user_id+" <br>on "+a[b].pc+
" <br>@ "+f);break;case "Connect":q.push(f);r.push("Device Access");s.push("User "+a[b].user_id+" <br>on "+a[b].pc+" <br>"+a[b].file_tree+" <br>@ "+f);break;case "Disconnect":t.push(f);u.push("Device Access");v.push("User "+a[b].user_id+" <br>on "+a[b].pc+" <br>"+a[b].file_tree+" <br>@ "+f);break;case "File Open":w.push(f);x.push("File Access");y.push("User "+a[b].user_id+" <br>on "+a[b].pc+" <br>File: "+a[b].filename);break;case "File Write":z.push(f);A.push("File Access");B.push("User "+a[b].user_id+
" <br>on "+a[b].pc+" <br>File: "+a[b].filename);break;case "File Copy":C.push(f);D.push("File Access");E.push("User "+a[b].user_id+" <br>on "+a[b].pc+" <br>File: "+a[b].filename);break;case "File Delete":F.push(f),fdelete_y.push("File Access"),fdelete_text.push("User "+a[b].user_id+" <br>on "+a[b].pc+" <br>File: "+a[b].filename)}}Plotly.newPlot("logon",[{x:d,y:g,name:"Logon",mode:"markers",marker:{color:"rgb(0, 255, 0)"},text:c,hoverinfo:"text+name",type:"bar"},{x:e,y:h,name:"Logoff",mode:"markers",
marker:{color:"rgb(255, 0, 0)"},text:p,hoverinfo:"text+name",type:"bar"},{x:q,y:r,name:"Connect",mode:"markers",text:s,hoverinfo:"text+name",type:"bar"},{x:t,y:u,name:"Disconnect",mode:"markers",text:v,hoverinfo:"text+name",type:"bar"},{x:w,y:x,name:"File Open",mode:"markers",text:y,hoverinfo:"text+name",type:"bar"},{x:z,y:A,name:"File Write",mode:"markers",text:B,hoverinfo:"text+name",type:"bar"},{x:C,y:D,name:"File Copy",mode:"markers",text:E,hoverinfo:"text+name",type:"bar"},{x:F,y:fdelete_y,name:"File Delete",
mode:"markers",text:fdelete_text,hoverinfo:"text+name",type:"bar"}],{title:"Activity chart",hovermode:"closest",barmode:"stack",xaxis:{rangeslider:{}},yaxis:{fixedrange:!0}},{displayModeBar:!1})},function(a){console.log("Errors")})}}]);app.controller("ChronoCtrl",["$scope","chronodatas",function(a,e){a.chronodatas=e.chronodatas;for(var c={title:{text:{headline:"test headline",text:"test text"}},events:[]},g={x:[],y:[],type:"bar"},d=a.chronodatas,h={},k=0;k<d.length;k++){var m=new Date(d[k].BreachDate);h[m.getFullYear()]?h[m.getFullYear()]+=d[k].Count:h[m.getFullYear()]=d[k].Count;if(!(5E6>d[k].Count)){var l={media:{},text:{},start_date:{}},n=d[k].Title,n=n.toLowerCase().replace(/ /g,""),n=n.toLowerCase().replace(".com","");l.media.url=
"//logo.clearbit.com/"+n+".com?size=150";l.text.headline=d[k].Title;l.text.text=d[k].Description;l.start_date.year=m.getFullYear();l.start_date.month=m.getMonth()+1;l.start_date.day=m.getDate();c.events.push(l)}}for(var G in h)g.x.push(G),g.y.push(h[G]);window.timeline=new TL.Timeline("chrono-timeline",c);Plotly.newPlot("chrono-display-1",[g],{title:"Yearly summary",hovermode:"closest"},{displayModeBar:!1})}]);app.controller("GraphCtrl",["$scope","$http","$q",function(a,e,c){a.user={};a.availableUsers=[];a.funcAsync=function(g){e.get("/allusers").then(function(d){a.availableUsers=d.data;console.log(d)},function(){console.log("Error")})};a.reloadGraph=function(){for(var g=["/userdata/logon/"+a.user.selected,"/userdata/device/"+a.user.selected,"/userdata/file/"+a.user.selected],d=[],h=0;h<g.length;h++)d.push(e.get(g[h]));var k=[];c.all(d).then(function(a){a=k=k.concat(a[0].data,a[1].data,a[2].data);var d=
[],g=[],c=[],e=[],h=[],p=[],q=[],r=[],s=[],t=[],u=[],v=[],w=[],x=[],y=[],z=[],A=[],B=[],C=[],D=[],E=[],F=[];fdelete_y=[];fdelete_text=[];for(var b=0;b<a.length;b++){var f;f=new Date(a[b].date);f=f.getFullYear()+"-"+("0"+(f.getMonth()+1)).slice(-2)+"-"+("0"+f.getDate()).slice(-2)+" "+f.getHours()+":"+f.getMinutes()+":"+f.getSeconds();switch(a[b].activity){case "Logon":d.push(f);g.push("Logon/Logoff");c.push("User "+a[b].user_id+" <br>on "+a[b].pc+" <br>@ "+f);break;case "Logoff":e.push(f);h.push("Logon/Logoff");
p.push("User "+a[b].user_id+" <br>on "+a[b].pc+" <br>@ "+f);break;case "Connect":q.push(f);r.push("Device Access");s.push("User "+a[b].user_id+" <br>on "+a[b].pc+" <br>"+a[b].file_tree+" <br>@ "+f);break;case "Disconnect":t.push(f);u.push("Device Access");v.push("User "+a[b].user_id+" <br>on "+a[b].pc+" <br>"+a[b].file_tree+" <br>@ "+f);break;case "File Open":w.push(f);x.push("File Access");y.push("User "+a[b].user_id+" <br>on "+a[b].pc+" <br>File: "+a[b].filename);break;case "File Write":z.push(f);
A.push("File Access");B.push("User "+a[b].user_id+" <br>on "+a[b].pc+" <br>File: "+a[b].filename);break;case "File Copy":C.push(f);D.push("File Access");E.push("User "+a[b].user_id+" <br>on "+a[b].pc+" <br>File: "+a[b].filename);break;case "File Delete":F.push(f),fdelete_y.push("File Access"),fdelete_text.push("User "+a[b].user_id+" <br>on "+a[b].pc+" <br>File: "+a[b].filename)}}Plotly.newPlot("logon",[{x:d,y:g,name:"Logon",mode:"markers",marker:{color:"rgb(0, 255, 0)"},text:c,hoverinfo:"text+name",
type:"scatter"},{x:e,y:h,name:"Logoff",mode:"markers",marker:{color:"rgb(255, 0, 0)"},text:p,hoverinfo:"text+name",type:"scatter"},{x:q,y:r,name:"Connect",mode:"markers",text:s,hoverinfo:"text+name",type:"scatter"},{x:t,y:u,name:"Disconnect",mode:"markers",text:v,hoverinfo:"text+name",type:"scatter"},{x:w,y:x,name:"File Open",mode:"markers",text:y,hoverinfo:"text+name",type:"scatter"},{x:z,y:A,name:"File Write",mode:"markers",text:B,hoverinfo:"text+name",type:"scatter"},{x:C,y:D,name:"File Copy",
mode:"markers",text:E,hoverinfo:"text+name",type:"scatter"},{x:F,y:fdelete_y,name:"File Delete",mode:"markers",text:fdelete_text,hoverinfo:"text+name",type:"scatter"}],{title:"Activity chart",hovermode:"closest"},{displayModeBar:!1})},function(a){console.log("Errors")})}}]);app.controller("MainCtrl",["$scope","posts","auth",function(a,e,c){a.posts=e.posts;a.isLoggedIn=c.isLoggedIn;a.addPost=function(){a.title&&""!==a.title&&(e.create({title:a.title,link:a.link}),a.title="",a.link="")};a.incrementUpvotes=function(a){e.upvote(a)}}]);app.controller("NavCtrl",["$scope","$state","auth",function(a,e,c){a.isLoggedIn=c.isLoggedIn;a.currentUser=c.currentUser;a.logOut=c.logOut}]);app.controller("PostsCtrl",["$scope","posts","post","auth",function(a,e,c,g){a.post=c;a.isLoggedIn=g.isLoggedIn;a.addComment=function(){""!==a.body&&(e.addComment(c._id,{body:a.body,author:"user"}).success(function(d){a.post.comments.push(d)}),a.body="")};a.incrementUpvotes=function(a){e.upvoteComment(c,a)}}]);app.controller("ProfCtrl",["$scope","$state","auth",function(a,e,c){a.updateProfile=function(){""!=a.firstName&&(user.firstName=a.firstName);""!=a.lastName&&(user.lastName=a.lastName);""!=a.email&&(user.email=a.email);""!=a.description&&(user.description=a.description)}}]);app.factory("chronodatas",["$http","auth",function(a,e){var c={chronodatas:[],getAll:function(){return a.get("/chronodatas").success(function(a){angular.copy(a,c.chronodatas)})}};return c}]);app.factory("posts",["$http","auth",function(a,e){var c={posts:[],getAll:function(){return a.get("/posts").success(function(a){angular.copy(a,c.posts)})},create:function(g){return a.post("/posts",g,{headers:{Authorization:"Bearer "+e.getToken()}}).success(function(a){c.posts.push(a)})},upvote:function(c){return a.put("/posts/"+c._id+"/upvote",null,{headers:{Authorization:"Bearer "+e.getToken()}}).success(function(a){c.upvotes+=1})},get:function(c){return a.get("/posts/"+c).then(function(a){return a.data})},
addComment:function(c,d){return a.post("/posts/"+c+"/comments",d,{headers:{Authorization:"Bearer "+e.getToken()}})},upvoteComment:function(c,d){return a.put("/posts/"+c._id+"/comments/"+d._id+"/upvote",null,{headers:{Authorization:"Bearer "+e.getToken()}}).success(function(a){d.upvotes+=1})}};return c}]);
